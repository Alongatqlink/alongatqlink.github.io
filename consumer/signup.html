<!DOCTYPE html>
<html lang="en-NG">
<head>
  <meta charset="UTF-8" />
  <title>QLINK Rider Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

  <!-- Select2 CSS + Bootstrap4 Theme -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap4-theme@1.6.2/dist/select2-bootstrap4.min.css" />

  <style>
    /* Base layout */
    html, body { overflow-x: hidden; }
    body {
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Card */
    .form-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #fff;
      border-radius: .25rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1; /* above watermark */
    }

    h1 { font-size: 2rem; font-weight: 700; }

    /* Buttons */
    .btn-landing, .btn-primary { width: 100%; padding: .75rem; font-size: 1.1rem; }

    /* Footer */
    footer {
      margin-top: auto;
      background: #e9ecef;
      padding: 15px 0;
      text-align: center;
      font-size: 0.9rem;
      color: #495057;
      border-top: 1px solid #dee2e6;
      z-index: 1;
      position: relative;
    }

    /* Watermark */
    .form-container::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("../images/watermark_1.png");
      background-repeat: no-repeat;
      background-position: center center;
      background-size: min(80vw, 500px) auto;
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }

    /* Select2 + Bootstrap consistency */
    .select2-container--bootstrap4 .select2-selection--single {
      display: flex !important;
      align-items: center !important;
      height: calc(2.25rem + 2px) !important;
      border: 1px solid #ced4da !important;
      border-radius: .25rem !important;
      background-color: #fff !important;
      padding: 0 !important;
      line-height: 1.5 !important;
    }
    .select2-container--bootstrap4 .select2-selection__rendered {
      margin: 0 .75rem !important;
      padding: 0 !important;
      line-height: 1.5 !important;
      color: #495057 !important;
      background: transparent !important; /* transparent text area */
    }
    .select2-container--bootstrap4 .select2-selection__placeholder { color: #6c757d !important; }
    .select2-container { width: 100% !important; }
    .select2-container--bootstrap4 .select2-dropdown { background-color: #fff; }
    .select2-container .select2-results__options {
      max-height: 320px;      /* adjust as you like */
      overflow-y: auto;
    }
    .select2-container--bootstrap4 .select2-dropdown {
      z-index: 9999 !important;
      position: absolute !important;
    }

    /* Mobile */
    @media (max-width: 576px) {
      .form-container { margin: 24px 12px; padding: 16px; }
    }
    .form-container .select2-container--bootstrap4 .select2-selection--single {
      background-color: transparent !important;
    }
    
    /* Ensure the text area inside selection stays transparent too */
    .form-container .select2-container--bootstrap4 .select2-selection__rendered {
      background: transparent !important;
    }
    
    /* Keep the dropdown results panel readable (white background) */
    .select2-container--bootstrap4 .select2-dropdown {
      background-color: #fff;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h1 class="h3 mb-4">QLINK Rider Registration</h1>

    <form id="vipForm" onsubmit="handleSubmit(event)" novalidate>
      <!-- Dealer Code (Select2) -->
      <div class="form-group">
        <label for="dealerCode">Dealer Code</label>
        <select id="dealerCode" class="form-control" required>
          <option value=""></option>
        </select>
        <small class="form-text text-muted">Confirm with your dealer if you don't know</small>
      </div>

      <!-- Model (Select2) -->
      <div class="form-group">
        <label for="model">Model10</label>
        <select id="model" class="form-control" required>
          <option value=""></option>
        </select>
      </div>

      <!-- Engine Serial -->
      <div class="form-group">
        <label for="productSerial">Engine Serial</label>
        <input
          type="text"
          class="form-control"
          id="productSerial"
          placeholder="Enter Engine Serial"
          autocomplete="off"
          required
          pattern="[A-Za-z0-9\s\-\_,.()\/]*"
        />
        <small class="form-text text-muted">Allowed: letters, numbers, space, and - _ , . ( ) /</small>
      </div>

      <!-- Customer Name -->
      <div class="form-group">
        <label for="CustomerName">Customer Name</label>
        <input
          type="text"
          class="form-control"
          id="CustomerName"
          placeholder="Enter your name"
          autocomplete="name"
          required
        />
      </div>

      <!-- Mobile Phone / WhatsApp -->
      <div class="form-group">
        <label for="phoneNumber">Mobile Phone / WhatsApp Number</label>
        <input
          type="tel"
          class="form-control"
          id="phoneNumber"
          placeholder="e.g. 08012345678"
          autocomplete="tel"
          required
          maxlength="11"
          inputmode="numeric"
        />
        <small id="phoneHelp" class="form-text text-muted">Enter a valid mobile phone number.</small>
        <div id="phoneError" class="text-danger mt-1" style="display:none; font-size:0.9rem;"></div>
      </div>

      <!-- Purchase Date (visible + hidden) -->
      <div class="form-group">
        <label for="purchaseDateDisplay">Purchase Date</label>

        <!-- Visible input (always DD/MM/YYYY for users) -->
        <input
          type="text"
          class="form-control"
          id="purchaseDateDisplay"
          placeholder="dd/mm/yyyy"
          inputmode="numeric"
          autocomplete="off"
          required
          onpointerdown="if (this.type !== 'date') { this.type='date'; this.showPicker && this.showPicker(); event.preventDefault(); }"
          onfocus="this.type='date'; setTimeout(()=>{ this.showPicker && this.showPicker(); },0);
                   if (document.getElementById('purchaseDate').value)
                     this.value = document.getElementById('purchaseDate').value;"
          onblur="if (!this.value) { this.type='text'; this.placeholder='dd/mm/yyyy'; }"
        />
        <!-- Hidden input (ISO YYYY-MM-DD for backend) -->
        <input type="hidden" id="purchaseDate" name="purchaseDate" />
      </div>

      <!-- Residential State -->
      <div class="form-group">
        <label for="state">Residential State</label>
        <select id="state" class="form-control" required>
          <option value=""></option>
          <option value="Abia">Abia</option>
          <option value="Adamawa">Adamawa</option>
          <option value="Akwa Ibom">Akwa Ibom</option>
          <option value="Anambra">Anambra</option>
          <option value="Bauchi">Bauchi</option>
          <option value="Bayelsa">Bayelsa</option>
          <option value="Benue">Benue</option>
          <option value="Borno">Borno</option>
          <option value="Cross River">Cross River</option>
          <option value="Delta">Delta</option>
          <option value="Ebonyi">Ebonyi</option>
          <option value="Edo">Edo</option>
          <option value="Ekiti">Ekiti</option>
          <option value="Enugu">Enugu</option>
          <option value="Gombe">Gombe</option>
          <option value="Imo">Imo</option>
          <option value="Jigawa">Jigawa</option>
          <option value="Kaduna">Kaduna</option>
          <option value="Kano">Kano</option>
          <option value="Katsina">Katsina</option>
          <option value="Kebbi">Kebbi</option>
          <option value="Kogi">Kogi</option>
          <option value="Kwara">Kwara</option>
          <option value="Lagos">Lagos</option>
          <option value="Nasarawa">Nasarawa</option>
          <option value="Niger">Niger</option>
          <option value="Ogun">Ogun</option>
          <option value="Ondo">Ondo</option>
          <option value="Osun">Osun</option>
          <option value="Oyo">Oyo</option>
          <option value="Plateau">Plateau</option>
          <option value="Rivers">Rivers</option>
          <option value="Sokoto">Sokoto</option>
          <option value="Taraba">Taraba</option>
          <option value="Yobe">Yobe</option>
          <option value="Zamfara">Zamfara</option>
          <option value="FCT Abuja">FCT Abuja</option>
        </select>
      </div>

      <!-- Residential LGA -->
      <div class="form-group">
        <label for="LGA">Residential LGA</label>
        <select id="LGA" class="form-control" required>
          <option value=""></option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Upload Invoice (PDF or Image)</label>
        
        <div class="d-flex align-items-center">
          <button type="button" id="invoiceChooseBtn" class="btn btn-light border">
            Choose File
          </button>
          <span id="invoiceFilename" class="ml-2 text-muted">No file chosen</span>
        </div>
      
        <small id="invoiceHelp" class="form-text text-muted">
          Allowed: PDF / JPG / PNG (Max 5MB). Make sure the invoice shows dealer, date & engine serial numbers.
        </small>
        
       <div id="invoiceProgressWrap" style="display:none; margin-top:8px;">
          <div class="progress" style="height:8px;">
            <div id="invoiceProgress" class="progress-bar" role="progressbar" style="width:0%;"></div>
          </div>
          <div id="invoiceStatus" style="font-size:12px; margin-top:6px; color:#666;"></div>
        </div>
        
        <img id="invoicePreview" alt="" style="display:none; max-width:160px; margin-top:8px; border-radius:6px;" />
        
        <input type="hidden" id="invoiceUrl" name="invoiceUrl" />
      </div>

      <!-- Note -->
      <p style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
        *Please ensure all details are accurate. Incorrect serial or mobile number will lead to
        <b>disqualification from promotions or warranty services</b>.
      </p>

      <button type="submit" class="btn btn-primary">Submit Registration</button>
    </form>
  
    <!-- hidden iframe target for upload -->
    <iframe name="uploader_iframe" id="uploader_iframe" style="display:none;"></iframe>
    
    <form id="invoiceUploadForm"
      action="https://script.google.com/macros/s/AKfycbxrv4RKZuEbqOKnywEgzzVrmtPqjJP46oOFkEq_o7KYPTZ33YT22tHVfMZ1hUBHT6WA/exec"
      method="post"
      enctype="multipart/form-data"
      target="uploader_iframe"
      style="margin:0; padding:0; border:0;">
    <input
      type="file"
      id="invoiceUpload"
      name="invoiceUpload"
      accept=".pdf,image/*"
      style="position:absolute; left:-9999px;" />
    </form>

    <div id="result" class="mt-3" aria-live="polite"></div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirm Your Information</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p><strong>Dealer Code:</strong> <span id="confirmDealerCode"></span></p>
          <p><strong>Model:</strong> <span id="confirmModel"></span></p>
          <p><strong>Product Serial:</strong> <span id="confirmProductSerial"></span></p>
          <p><strong>Customer Name:</strong> <span id="confirmCustomerName"></span></p>
          <p><strong>Phone Number:</strong> <span id="confirmPhoneNumber"></span></p>
          <p><strong>Purchase Date:</strong> <span id="confirmPurchaseDate"></span></p>
          <p><strong>Residential State:</strong> <span id="confirmState"></span></p>
          <p><strong>Residential LGA:</strong> <span id="confirmLGA"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button id="confirmBtn" type="button" class="btn btn-primary">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-body py-4">
          <div id="resultIcon" style="font-size: 2rem; margin-bottom: .5rem;"></div>
          <div id="resultMessage"></div>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div>© 2025 QLINK. All rights reserved.</div>
    <div>Contact us: <a href="https://www.facebook.com/QLINKMotorcycleNigeria/">Facebook</a></div>
  </footer>

  <!-- jQuery + Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
  // ===== Config =====
  const MAX_SIZE_MB = 5;
  const ALLOWED_MIMES = [
    'application/pdf',
    'image/jpeg','image/png','image/gif','image/webp',
    'image/heic','image/heif'
  ];

  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrv4RKZuEbqOKnywEgzzVrmtPqjJP46oOFkEq_o7KYPTZ33YT22tHVfMZ1hUBHT6WA/exec';
  
  // ===== DOM Elements =====
  const chooseBtn    = document.getElementById('invoiceChooseBtn');
  const fileNameEl   = document.getElementById('invoiceFilename');
  const fileInput    = document.getElementById('invoiceUpload');
  const hiddenUrl    = document.getElementById('invoiceUrl');
  const uploadForm   = document.getElementById('invoiceUploadForm');
  const uploadIframe = document.getElementById('uploader_iframe');

  uploadForm.action = 'https://script.google.com/macros/s/AKfycbxrv4RKZuEbqOKnywEgzzVrmtPqjJP46oOFkEq_o7KYPTZ33YT22tHVfMZ1hUBHT6WA/exec';
  
  const progressWrap = document.getElementById('invoiceProgressWrap');
  const progressBar  = document.getElementById('invoiceProgress');
  const statusText   = document.getElementById('invoiceStatus');
  const previewImg   = document.getElementById('invoicePreview');
    
  // ===== Utility Functions =====
  function resetProgress() {
    progressWrap.style.display = 'none';
    progressBar.style.width = '0%';
    statusText.textContent = '';
  }
  
  function showProgress(pct, text) {
    progressWrap.style.display = 'block';
    progressBar.style.width = pct + '%';
    if (text) statusText.textContent = text;
  }
  
  function showPreviewIfImage(file) {
    if (file && file.type.startsWith('image/')) {
      previewImg.src = URL.createObjectURL(file);
      previewImg.style.display = 'block';
    } else {
      previewImg.style.display = 'none';
      previewImg.src = '';
    }
  }
  
  // ===== Event Listeners ===== 
    chooseBtn.addEventListener('click', () => fileInput.click());

    // When a file is selected
    fileInput.addEventListener('change', () => {
      fileNameEl.textContent = fileInput.files[0]?.name || 'No file chosen';
      resetProgress();
      hiddenUrl.value = '';
    
      const file = fileInput.files && fileInput.files[0];
      showPreviewIfImage(file);
      
      if (!file) return;
    
      // Frontend validations
      if (!ALLOWED_MIMES.includes(file.type)) {
        alert('Please upload a PDF or image.');
        fileInput.value = '';
        fileNameEl.textContent = 'No file chosen';
        return;
      }  
      if (file.size > MAX_SIZE_MB * 1024 * 1024) {
        alert('File too large. Max 5MB.');
        fileInput.value = '';
        fileNameEl.textContent = 'No file chosen';
        return;
      }
            
      // fake progress while uploading via iframe
    let p = 0;
    showProgress(1, 'Starting upload…');
    const progressTimer = setInterval(() => {
      p = Math.min(99, p + Math.random() * 12);
      showProgress(Math.floor(p), `Uploading… ${Math.floor(p)}%`);
    }, 200);
    
      // listen only once for the response
      const onMessage = (ev) => {
      if (!ev.origin.includes('script.google.com')) return;
      }
     let data = ev.data;
      if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch {}
      }
        
      if (data && (data.ok === true || data.ok === false)) {
      window.removeEventListener('message', onMessage);
      clearInterval(progressTimer);
      clearTimeout(failTimer);
          
      if (data.ok) {
        hiddenUrl.value = data.url;
        showProgress(100, 'Uploaded ✓');
        console.log('Upload successful, URL:', data.url);
      } else {
        alert(data.error || 'Upload failed.');
        fileInput.value = '';
        fileNameEl.textContent = 'No file chosen';
        resetProgress();
      }
    }
  };  
 window.addEventListener('message', onMessage);    
  
  // 15 second timeout protection
  const failTimer = setTimeout(() => {
    window.removeEventListener('message', onMessage);
    clearInterval(progressTimer);
    resetProgress();
    alert('Upload timeout: no response from server after 15 seconds.');
    fileInput.value = '';
    fileNameEl.textContent = 'No file chosen';
    console.error('Upload timeout');
  }, 15000);
  
  // Submit form to iframe
  uploadForm.submit();
});
  </script>
 <script>
    // Mock data
    var dealerCodes = ["5KEL","5OSW","5OSY-B","5PAT","5PEE","5MAE","5POV","5MBA","5PRO","5RAG","5REB","5ROL","5OCI","5MBF"];
    var modelCodes = ["TARGET 110","VELOCITY 110","REIZ 110","WISDOM 110","AGRO 200","AGRO 150","RKT 200","CHAMPION 200","TIGER 150","TIGER 160","MONSTER 2.0","GD 110","CRUISER 125","SPRINT 150","D-SUPER 150","TIGER 200","QG 125","QG 125-I","QGL-G12","QGL-G8","LUCKY ULTRA 110","UD ULTRA 110","XPREZ 125"];

    // LGA map (truncated for brevity) — keep your full object here
    const LGAByState = {
      "Abia": ["Aba North","Aba South","Arochukwu","Bende","Ikwuano","Isiala-Ngwa North","Isiala-Ngwa South","Isuikwato","Ngwa","Obi Nwa","Ohafia","Osisioma","Ugwunagbo","Ukwa East","Ukwa West","Umu-Neochi","Umuahia North","Umuahia South"],
      "Adamawa": ["Demsa","Fufore","Ganaye","Gireri","Gombi","Guyuk","Hong","Jada","Lamurde","Madagali","Maiha","Mayo-Belwa","Michika","Mubi North","Mubi South","Numan","Shelleng","Song","Toungo","Yola North","Yola South"],
      "Akwa Ibom": ["Abak","Eastern Obolo","Eket","Esit Eket","Essien Udim","Etim Ekpo","Etinan","Ibeno","Ibesikpo Asutan","Ibiono Ibom","Ika","Ikono","Ikot Abasi","Ikot Ekpene","Ini","Itu","Mbo","Mkpat Enin","Nsit Atai","Nsit Ibom","Nsit Ubium","Obot Akara","Okobo","Onna","Oron","Oruk Anam","Udung Uko","Ukanafun","Uruan","Urue-Offong/Oruko","Uyo"],
      "Anambra": ["Aguata","Anambra East","Anambra West","Anaocha","Awka North","Awka South","Ayamelum","Dunukofia","Ekwusigo","Idemili North","Idemili south","Ihiala","Njikoka","Nnewi North","Nnewi South","Ogbaru","Onitsha North","Onitsha South","Orumba North","Orumba South","Oyi"],
      "Bauchi": ["Alkaleri","Bauchi","Bogoro","Damban","Darazo","Dass","Gamawa","Ganjuwa","Giade","Itas/Gadau","Jama'are","Katagum","Kirfi","Misau","Ningi","Shira","Tafawa-Balewa","Toro","Warji","Zaki"],
      "Bayelsa": ["Brass","Ekeremor","Kolokuma/Opokuma","Nembe","Ogbia","Sagbama","Southern Jaw","Yenegoa"],
      "Benue": ["Ado","Agatu","Apa","Buruku","Gboko","Guma","Gwer East","Gwer West","Katsina-Ala","Konshisha","Kwande","Logo","Makurdi","Obi","Ogbadibo","Ohimini","Oju","Okpokwu","Oturkpo","Tarka","Ukum","Ushongo","Vandeikya"],
      "Borno": ["Abadam","Askira/Uba","Bama","Bayo","Biu","Chibok","Damboa","Dikwa","Gubio","Guzamala","Gwoza","Hawul","Jere","Kaga","Kala/Balge","Konduga","Kukawa","Kwaya Kusar","Mafa","Magumeri","Maiduguri","Marte","Mobbar","Monguno","Ngala","Nganzai","Shani"],
      "Cross River": ["Abi","Akamkpa","Akpabuyo","Bakassi","Bekwara","Biase","Boki","Calabar Municipality","Calabar South","Etung","Ikom","Obanliku","Obudu","Odubra","Odukpani","Ogoja","Yala","Yarkur"],
      "Delta": ["Aniocha","Aniocha South","Bomadi","Burutu","Ethiope East","Ethiope West","Ika North-East","Ika South","Isoko North","Isoko south","Ndokwa East","Ndokwa West","Okpe","Oshimili","Oshimili North","Patani","Sapele","Udu","Ughelli North","Ughelli South","Ukwani","Uvwie","Warri Central","Warri North","Warri South"],
      "Ebonyi": ["Abakaliki","Afikpo","Ebonyi","Edda","Ezza","Ezza Central","Ezza South","Ishielu","Ivo","lkwo","Ohaozara","Ohaukwu","Onicha"],
      "Edo": ["Central","Egor","Esan Central","Esan North-East","Esan South-East","Esan West","Etsako Central","Etsako East","Etsako West","Igueben","Ikpoba-Okha","Oredo","Orhionwon","Ovia North-East","Ovia South-East","Ovia SouthWest","Uhunmwonde","Ukpoba"],
      "Ekiti": ["Ado Ekiti","Efon","Ekiti South-West","Ekiti-East","Ekiti-West","Emure/Ise/Orun","Gbonyin","Ido/Osi","Ijero","Ikere","Ikole","Ilejemeje.","Irepodun-Ifelodun","Ise/Orun","Moba","Oye"],
      "Enugu": ["Aninri","Enugu Eas","Enugu North","Enugu South","Ezeagu","Igbo-Ekiti","Igbo-Eze South","IgboEze North","Isi-Uzo","Nkanu","Nkanu East","Nkanu West","Nsukka","Oji-River","Udenu.","Udi Agwu","Uzo-Uwani"],
      "FCT": ["Abaji","Abuja Municipal","Bwari","Gwagwalada","Kuje","Kwali"],
      "FCT Abuja": ["Abaji","Abuja Municipal","Bwari","Gwagwalada","Kuje","Kwali"],
      "Gombe": ["Akko","Balanga","Billiri","Dukku","Funakaye","Gombe","Kaltungo","Kwami","Nafada/Bajoga","Shomgom","Yamaltu/Delta."],
      "Imo": ["Aboh-Mbaise","Ahiazu-Mbaise","Ehime-Mbano","Ezinihitte","Ideato North","Ideato South","Ihitte/Uboma","Ikeduru","Isiala Mbano","Isu","Mbaitoli","Ngor-Okpala","Njaba","Nkwerre","Nwangele","Obowo","Oguta","Ohaji/Egbema","Okigwe","Orlu","Orsu","Oru East","Oru West","Owerri North","Owerri West","Owerri-Municipal"],
      "Jigawa": ["Auyo","Babura","Biriniwa","Birni Kudu","Buji","Dutse","Gagarawa","Garki","Gumel","Guri","Gwaram","Gwiwa","Hadejia","Jahun","Kafin Hausa","Kaugama Kazaure","Kiri Kasamma","Kiyawa","Maigatari","Malam Madori","Miga","Ringim","Roni","Sule-Tankarkar","Taura","Yankwashi"],
      "Kaduna": ["Birni-Gwari","Chikun","Giwa","Igabi","Ikara","jaba","Jema'a","Kachia","Kaduna North","Kaduna South","Kagarko","Kajuru","Kaura","Kauru","Kubau","Kudan","Lere","Makarfi","Sabon-Gari","Sanga","Soba","Zango-Kataf","Zaria"],
      "Kano": ["Ajingi","Albasu","Bagwai","Bebeji","Bichi","Bunkure","Dala","Dambatta","Dawakin Kudu","Dawakin Tofa","Doguwa","Fagge","Gabasawa","Garko","Garum","Gaya","Gezawa","Ghari","Gwale","Gwarzo","Kabo","Kano Municipal","Karaye","Kibiya","Kiru","kumbotso","Kunchi","Kura","Madobi","Makoda","Mallam","Minjibir","Nasarawa","Rano","Rimin Gado","Rogo","Shanono","Sumaila","Takali","Tarauni","Tofa","Tsanyawa","Tudun Wada","Ungogo","Warawa","Wudil"],
      "Katsina": ["Bakori","Batagarawa","Batsari","Baure","Bindawa","Charanchi","Dan Musa","Dandume","Danja","Daura","Dutsi","Dutsin-Ma","Faskari","Funtua","Ingawa","Jibia","Kafur","Kaita","Kankara","Kankia","Katsina","Kurfi","Kusada","Mai'Adua","Malumfashi","Mani","Mashi","Matazuu","Musawa","Rimi","Sabuwa","Safana","Sandamu","Zango"],
      "Kebbi": ["Aleiro","Arewa-Dandi","Argungu","Augie","Bagudo","Birnin Kebbi","Bunza","Dandi","Fakai","Gwandu","Jega","Kalgo","Koko/Besse","Maiyama","Ngaski","Sakaba","Shanga","Suru","Wasagu/Danko","Yauri","Zuru"],
      "Kogi": ["Adavi","Ajaokuta","Ankpa","Bassa","Dekina","Ibaji","Idah","Igalamela-Odolu","Ijumu","Kabba/Bunu","Kogi","Lokoja","Mopa-Muro","Ofu","Ogori/Mangongo","Okehi","Okene","Olamabolo","Omala","Yagba East","Yagba West"],
      "Kwara": ["Asa","Baruten","Edu","Ekiti","Ifelodun","Ilorin East","Ilorin West","Irepodun","Isin","Kaiama","Moro","Offa","Oke-Ero","Oyun","Pategi"],
      "Lagos": ["Agege","Ajeromi-Ifelodun","Alimosho","Amuwo-Odofin","Apapa","Badagry","Epe","Eti-Osa","Ibeju/Lekki","Ifako-Ijaye","Ikeja","Ikorodu","Kosofe","Lagos Island","Lagos Mainland","Mushin","Ojo","Oshodi-Isolo","Shomolu","Surulere"],
      "Nasarawa": ["Akwanga","Awe","Doma","Karu","Keana","Keffi","Kokona","Lafia","Nasarawa","Nasarawa-Eggon","Obi","Toto","Wamba"],
      "Niger": ["Agaie","Agwara","Bida","Borgu","Bosso","Chanchaga","Edati","Gbako","Gurara","Katcha","Kontagora","Lapai","Lavun","Magama","Mariga","Mashegu","Mokwa","Muya","Pailoro","Rafi","Rijau","Shiroro","Suleja","Tafa","Wushishi"],
      "Ogun": ["Abeokuta North","Abeokuta South","Ado-Odo/Ota","Ewekoro","Ifo","Ijebu East","Ijebu North","Ijebu North East","Ijebu Ode","Ikenne","Imeko-Afon","Ipokia","Obafemi-Owode","Odeda","Odogbolu","Ogun Waterside","Remo North","Shagamu","Yewa North","Yewa South"],
      "Ondo": ["Akoko North East","Akoko North West","Akoko South East","Akoko South West","Akure North","Akure South","Ese-Odo","Idanre","Ifedore","Ilaje","Ile-Oluji","Irele","Odigbo","Okeigbo","Okitipupa","Ondo East","Ondo West","Ose","Owo"],
      "Osun": ["Aiyedade","Aiyedire","Atakumosa East","Atakumosa West","Boluwaduro","Boripe","Ede North","Ede South","Egbedore","Ejigbo","Ife Central","Ife East","Ife North","Ife South","Ifedayo","Ifelodun","Ila","Ilesha East","Ilesha West","Irepodun","Irewole","Isokan","Iwo","Obokun","Odo-Otin","Ola-Oluwa","Olorunda","Oriade","Orolu","Osogbo"],
      "Oyo": ["Afijio","Akinyele","Atiba","Atisbo","Egbeda","Ibadan Central","Ibadan North","Ibadan North West","Ibadan South East","Ibadan South West","Ibarapa Central","Ibarapa East","Ibarapa North","Ido","Irepo","Iseyin","Itesiwaju","Iwajowa","Kajola","Lagelu Ogbomosho North","Ogbomosho South","Ogo Oluwa","Olorunsogo","Oluyole","Ona-Ara","Orelope","Ori Ire","Oyo East","Oyo West","Saki East","Saki West","Surulere"],
      "Plateau": ["Barikin Ladi","Bassa","Bokkos","Jos East","Jos North","Jos South","Kanam","Kanke","Langtang North","Langtang South","Mangu","Mikang","Pankshin","Qua'an Pan","Riyom","Shendam","Wase"],
      "Rivers": ["Abua/Odual","Ahoada East","Ahoada West","Akuku Toru","Andoni","Asari-Toru","Bonny","Degema","Eleme","Emohua","Etche","Gokana","Ikwerre","Khana","Obio/Akpor","Ogba/Egbema/Ndoni","Ogu/Bolo","Okrika","Omumma","Opobo/Nkoro","Oyigbo","Port-Harcourt","Tai"],
      "Sokoto": ["Binji","Bodinga","Dange-shnsi","Gada","Gawabawa","Goronyo","Gudu","Illela","Isa","kebbe","Kware","Rabah","Sabon birni","Shagari","Silame","Sokoto North","Sokoto South","Tambuwal","Tqngaza","Tureta","Wamako","Wurno","Yabo"],
      "Taraba": ["Ardo-kola","Bali","Cassol","Donga","Gashaka","Ibi","Jalingo","Karin-Lamido","Kurmi","Lau","Sardauna","Takum","Ussa","Wukari","Yorro","Zing"],
      "Yobe": ["Bade","Bursari","Damaturu","Fika","Fune","Geidam","Gujba","Gulani","Jakusko","Karasuwa","Karawa","Machina","Nangere","Nguru Potiskum","Tarmua","Yunusari","Yusufari"],
      "Zamfara": ["Anka","Bakura","Birnin Magaji","Bukkuyum","Bungudu","Gummi","Gusau","Kaura-Namoda","Maradun","Maru","Namoda","Shinkafi","Talata Mafara","Tsafe","Zurmi"]
    };

    // Allowed characters validator
    function isInvalidInput(v){ return !/^[a-zA-Z0-9\s\-\_,.()\/]*$/.test(v); }

    // Modal helper
    function showResult(type, message){
      const icons = { success:'<span class="text-success">✅</span>', error:'<span class="text-danger">❌</span>', warning:'<span class="text-warning">⚠️</span>' };
      $("#resultIcon").html(icons[type] || '');
      $("#resultMessage").text(message);
      $("#resultModal").modal("show");
    }

    // Reset form
    function resetForm(){
      document.getElementById("vipForm").reset();
      $("#dealerCode,#model,#state,#LGA").val(null).trigger("change");
      $("#result").text("").removeClass("text-success text-danger");
    }

    // Utility: ISO -> DD/MM/YYYY
    function toDDMMYYYY(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    // Init
  $(document).ready(function () {
    const $parent = $('.form-container');

    // --- Dealer Code ---
    const $dealer = $('#dealerCode');
    $dealer.empty().append('<option value=""></option>');
    dealerCodes.forEach(c => $dealer.append(new Option(c, c)));
    $dealer.select2({
      placeholder: 'Select your dealer',
      theme: 'bootstrap4',
      dropdownParent: $parent
    }).on('select2:open', () => {
      $('.select2-search__field').attr('placeholder','Type here to search your dealer...');
    });

    // --- Model ---
    const $model = $('#model');
    $model.empty().append('<option value=""></option>');
    modelCodes.forEach(m => $model.append(new Option(m, m)));
    $model.select2({
      placeholder: 'Select your model',
      theme: 'bootstrap4',
      dropdownParent: $parent
    }).on('select2:open', () => {
      $('.select2-search__field').attr('placeholder','Type here to search Model...');
    });

    // --- State ---
    $('#state').select2({
      placeholder: 'Type to search State...',
      theme: 'bootstrap4',
      dropdownParent: $parent
    });

    // --- LGA ---
    $('#LGA').select2({
      placeholder: 'Type to search LGA...',
      theme: 'bootstrap4',
      dropdownParent: $parent
    });

    // --- State → LGA ---
    $('#state').on('change', function () {
      const st   = $(this).val();
      const list = LGAByState[st] || (st === 'FCT Abuja' ? LGAByState['FCT Abuja'] : []);
      const $lga = $('#LGA');
      $lga.html('<option value=""></option>');
      (list || []).forEach(l => $lga.append(new Option(l, l)));
      $lga.val(null).trigger('change.select2');
    });

    // ---- Date: limit to today on visible input ----
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseDateDisplay').setAttribute('max', today);

    // ---- Phone guard rails ----
    const phoneInput = document.getElementById('phoneNumber');
    const phoneError = document.getElementById('phoneError');
    phoneInput.setAttribute('inputmode','numeric');
    phoneInput.setAttribute('maxlength','11');

    function validatePhoneField(){
      const v = phoneInput.value || '';
      const ok = /^0\d{10}$/.test(v);
      if (!v) { phoneError.style.display='none'; phoneInput.classList.remove('is-invalid'); return false; }
      if (!ok){ phoneError.textContent='Invalid mobile phone number format.'; phoneError.style.display='block'; phoneInput.classList.add('is-invalid'); return false; }
      phoneError.style.display='none'; phoneInput.classList.remove('is-invalid'); return true;
    }
    phoneInput.addEventListener('input', function(){
      let v = this.value.replace(/\D/g,'').slice(0,11);
      this.value = v;
      validatePhoneField();
    });
    phoneInput.addEventListener('blur', validatePhoneField);
    window.__validatePhoneField = validatePhoneField;

    // ---- Date display ↔ hidden sync ----
    const display = document.getElementById('purchaseDateDisplay');
    const hidden  = document.getElementById('purchaseDate');

    display.addEventListener('change', function(){
      if (!this.value) return;
      if (this.type === 'date' && this.value.includes('-')) {
        const [y,m,d] = this.value.split('-');
        hidden.value = `${y}-${m}-${d}`;
        this.type = 'text';
        this.value = `${d}/${m}/${y}`;
      }
    });

    // Convert manual DD/MM/YYYY to ISO on submit
    document.getElementById('vipForm').addEventListener('submit', function(e){
      const m = (display.value || '').trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m){
        const [,d,mo,y] = m;
        hidden.value = `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      }
      if (!hidden.value){
        e.preventDefault();
        alert('Please enter a valid date in DD/MM/YYYY.');
        display.focus();
      }
    });
  });

    // Submit handler (confirm -> post)
  function handleSubmit(e){
    e.preventDefault();
  
    // ✅ Guard: make sure the invoice has been uploaded
    const invoiceUrlVal = (document.getElementById('invoiceUrl')?.value || '').trim();
    if (!invoiceUrlVal) {
      $("#result")
        .text("Please upload your invoice first.")
        .removeClass("text-success")
        .addClass("text-danger");
      document.getElementById('invoiceUpload')?.focus();
      return; // stop submit
    }

      const dealerCode    = ($("#dealerCode").val()    || "").toString().trim();
      const model         = ($("#model").val()         || "").toString().trim();
      const productSerial = ($("#productSerial").val() || "").toString().trim();
      const customerName  = ($("#CustomerName").val()  || "").toString().trim();
      const phoneNumber   = ($("#phoneNumber").val()   || "").toString().trim();
      const purchaseDate  = ($("#purchaseDate").val()  || "").toString().trim(); // ISO
      const state         = ($("#state").val()         || "").toString().trim();
      const LGA           = ($("#LGA").val()           || "").toString().trim();

      // Required
      if(!dealerCode || !model || !productSerial || !customerName || !phoneNumber || !purchaseDate || !state || !LGA){
        $("#result").text("Please fill out all required fields.").removeClass("text-success").addClass("text-danger");
        return;
      }

      // Phone validation
      if(typeof window.__validatePhoneField === "function" && !window.__validatePhoneField()){
        $("#result").text("Please correct phone number.").removeClass("text-success").addClass("text-danger");
        return;
      }

      // Character whitelist
      if([dealerCode, model, productSerial, customerName, purchaseDate, state, LGA].some(isInvalidInput)){
        $("#result").text("Invalid characters detected.").removeClass("text-success").addClass("text-danger");
        return;
      }

      // Fill confirm modal (show date as DD/MM/YYYY)
      $("#confirmDealerCode").text(dealerCode);
      $("#confirmModel").text(model);
      $("#confirmProductSerial").text(productSerial);
      $("#confirmCustomerName").text(customerName);
      $("#confirmPhoneNumber").text(phoneNumber);
      $("#confirmPurchaseDate").text(toDDMMYYYY(purchaseDate));
      $("#confirmState").text(state);
      $("#confirmLGA").text(LGA);

      $("#confirmModal").modal("show");

      // Confirm -> POST
      $("#confirmBtn").off("click").on("click", function(){
        $("#confirmModal").modal("hide");

        const formData = new URLSearchParams();
        formData.append("dealerCode", dealerCode);
        formData.append("model", model);
        formData.append("productSerial", productSerial);
        formData.append("CustomerName", customerName);
        formData.append("phoneNumber", phoneNumber);
        formData.append("purchaseDate", purchaseDate); // ISO
        formData.append("state", state);
        formData.append("LGA", LGA);

        fetch("https://script.google.com/macros/s/AKfycbzECGqAyJ7Gf88Tgw1DpG4C9mW1qFQCq0OtPmmx1RGS-_esSBE8WOmwed3-Fc5kDdPH/exec", { method:"POST", body: formData })
          .then(r => r.text())
          .then(text => {
            let data; try { data = JSON.parse(text); } catch { showResult("warning","Response format error. Please try again later."); return; }
            if(data.result === "success"){ showResult("success","Registration successful!"); resetForm(); }
            else { showResult("error","Registration failed: " + (data.error || "Unknown error.")); }
          })
          .catch(()=> showResult("error","Network/server error. Please try again later."));
      });
    }
  </script>
</body>
</html>
